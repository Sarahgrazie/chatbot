import streamlit as st
from openai import OpenAI

# í™”ë©´ ì œëª©ê³¼ ì„œë¹„ìŠ¤ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤.
st.title("ğŸ’¬ Kì˜ ì—¬í–‰ ê°€ì´ë“œ ì„œë¹„ìŠ¤")
st.write(
    "OpenAIì˜ GPT-3.5 ëª¨ë¸ì„ í™œìš©í•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ê°„ë‹¨í•œ ì±—ë´‡ì…ë‹ˆë‹¤. "
     "ì–´ì„œì˜¤ì„¸ìš”! í‰ë²”í•œ ì±—ë´‡ê³¼ëŠ” ì°¨ì›ì´ ë‹¤ë¥¸, ë‹¹ì‹ ë§Œì„ ìœ„í•œ ë§ì¶¤í˜• ì—¬í–‰ ê²½í—˜ì„ ì„ ì‚¬í•©ë‹ˆë‹¤. Kì˜ ì—¬í–‰ ê°€ì´ë“œ ì„œë¹„ìŠ¤ëŠ” ìµœì²¨ë‹¨ AI ê¸°ìˆ ì¸ OpenAIì˜ GPT-3.5 ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ, ë‹¹ì‹ ì˜ ëª¨ë“  ì—¬í–‰ ê´€ë ¨ ì§ˆë¬¸ì— ëª…í™•í•˜ê³  ì°½ì˜ì ì¸ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤."
     "ë” ì´ìƒ ë³µì¡í•œ ì •ë³´ ê²€ìƒ‰ì— ì‹œê°„ì„ ë‚­ë¹„í•˜ì§€ ë§ˆì„¸ìš”. Kì˜ ì—¬í–‰ ê°€ì´ë“œ ì„œë¹„ìŠ¤ëŠ” ë‹¹ì‹ ì´ ê¿ˆê¾¸ëŠ” ì™„ë²½í•œ ì—¬í–‰ì„ í˜„ì‹¤ë¡œ ë§Œë“¤ì–´ ì¤„ ì—¬ì •ì„ ì•ˆë‚´í•©ë‹ˆë‹¤."
  
)

# ì‚¬ìš©ìë¡œë¶€í„° OpenAI API í‚¤ë¥¼ ì…ë ¥ë°›ëŠ” í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# `type="password"` ì„¤ì •ì„ í†µí•´ ì…ë ¥ ë‚´ìš©ì´ ê°€ë ¤ì§€ë„ë¡ í•©ë‹ˆë‹¤.
openai_api_key = st.text_input("OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", type="password")

# OpenAI API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°, ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
if not openai_api_key:
    st.info("OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”. ğŸ—ï¸")
else:
    # OpenAI í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. API í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•©ë‹ˆë‹¤.
    client = OpenAI(api_key=openai_api_key)

    # ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡ì„ ì €ì¥í•˜ê¸° ìœ„í•œ ì„¸ì…˜ ìƒíƒœ ë³€ìˆ˜ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    # ì„¸ì…˜ ìƒíƒœëŠ” ì•±ì´ ë‹¤ì‹œ ì‹¤í–‰ë˜ì–´ë„ ê°’ì„ ìœ ì§€í•©ë‹ˆë‹¤.
    if "messages" not in st.session_state:
        st.session_state.messages = []

    # ì €ì¥ëœ ì±„íŒ… ë©”ì‹œì§€ë“¤ì„ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
    # ê° ë©”ì‹œì§€ëŠ” ì—­í• ("user" ë˜ëŠ” "assistant")ì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ì‚¬ìš©ìë¡œë¶€í„° ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì…ë ¥ë°›ëŠ” ì…ë ¥ í•„ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    # ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enter í‚¤ë¥¼ ëˆ„ë¥´ë©´ `prompt` ë³€ìˆ˜ì— ë‚´ìš©ì´ ì €ì¥ë©ë‹ˆë‹¤.
    if prompt := st.chat_input("ê¶ê¸ˆí•œ ì—¬í–‰ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"):

        # ì‚¬ìš©ìì˜ ì…ë ¥(í”„ë¡¬í”„íŠ¸)ì„ ì„¸ì…˜ ìƒíƒœì˜ ë©”ì‹œì§€ ëª©ë¡ì— ì¶”ê°€í•˜ê³  í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # OpenAI APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì±—ë´‡ì˜ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
        # `gpt-3.5-turbo` ëª¨ë¸ì„ ì‚¬ìš©í•˜ë©°, ì´ì „ ëŒ€í™” ë‚´ìš©ì„ í•¨ê»˜ ì „ë‹¬í•˜ì—¬ ë§¥ë½ì„ ìœ ì§€í•©ë‹ˆë‹¤.
        # `stream=True` ì„¤ì •ì„ í†µí•´ ì‘ë‹µì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì•„ í™”ë©´ì— í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        stream = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": m["role"], "content": m["content"]}
                for m in st.session_state.messages
            ],
            stream=True,
        )

        # ì±—ë´‡ì˜ ì‘ë‹µì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™”ë©´ì— í‘œì‹œí•˜ê³ , ì„¸ì…˜ ìƒíƒœì— ì €ì¥í•©ë‹ˆë‹¤.
        with st.chat_message("assistant"):
            response = st.write_stream(stream)
        st.session_state.messages.append({"role": "assistant", "content": response})
